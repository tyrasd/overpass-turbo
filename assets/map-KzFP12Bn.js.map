{"version":3,"file":"map-KzFP12Bn.js","names":[],"sources":["../../css/map.css","../../js/map.ts"],"sourcesContent":["html {\n  margin: 0;\n  padding: 0;\n}\nbody {\n  margin: 0;\n  padding: 0;\n}\n#map {\n  position: absolute;\n  margin: 0;\n  padding: 0;\n  top: 0;\n  left: 0;\n  right: 0;\n  bottom: 0;\n}\n.leaflet-popup-pane {\n  opacity: 0.88;\n}\n.leaflet-popup-content-wrapper {\n  border-radius: 3px;\n}\n","// escape strings to show them directly in the html.\nimport $ from \"jquery\";\nimport \"leaflet\";\n// include the CSS files\nimport \"leaflet/dist/leaflet.css\";\nimport \"../css/map.css\";\nimport configs from \"./configs\";\nimport overpass from \"./overpass\";\nimport Query from \"./query\";\nimport {parseUrlParameters} from \"./urlParameters\";\n\n$(document).ready(() => {\n  // main map cache\n  const cache = {};\n\n  window.addEventListener(\n    \"message\",\n    async (evt) => {\n      const data = typeof evt.data === \"string\" ? JSON.parse(evt.data) : {};\n      if (data.cmd === \"update_map\") {\n        settings.code[\"overpass\"] = data.value[0];\n        ide.update_map();\n      } else if (data.cmd === \"cache\") {\n        settings.code[\"overpass\"] = data.value[0];\n        const query = await ide.getQuery();\n        const query_lang = ide.getQueryLang();\n        overpass.run_query(\n          query,\n          query_lang,\n          cache,\n          true,\n          undefined,\n          undefined,\n          ide.mapcss\n        );\n      }\n    },\n    false\n  );\n\n  // some initalizations\n  $.fn.dialog = function () {\n    alert(`error :( ${$(this).html()}`);\n  };\n  configs.appname = \"overpass-ide-map\";\n  const settings = {\n    code: {},\n    server: configs.defaultServer,\n    tileServer: configs.defaultTiles,\n    silent: false,\n    force_simple_cors_request: true,\n    disable_poiomatic: false\n  };\n  const ide = {\n    map: undefined as unknown as L.Map,\n    mapcss: \"\",\n    async getQuery(): Promise<string> {\n      let query = settings.code[\"overpass\"];\n      const queryParser = new Query();\n      query = await queryParser.parse(query, {});\n      // parse mapcss declarations\n      let mapcss = \"\";\n      if (queryParser.hasStatement(\"style\"))\n        mapcss = queryParser.getStatement(\"style\");\n      ide.mapcss = mapcss;\n      // parse data-source statements\n      let data_source = null;\n      if (queryParser.hasStatement(\"data\")) {\n        data_source = queryParser.getStatement(\"data\");\n        data_source = data_source.split(\",\");\n        const data_mode = data_source[0].toLowerCase();\n        data_source = data_source.slice(1);\n        const options = {};\n        for (const src of data_source) {\n          const tmp = src.split(\"=\");\n          options[tmp[0]] = tmp[1];\n        }\n        data_source = {\n          mode: data_mode,\n          options: options\n        };\n      }\n      ide.data_source = data_source;\n      // remove newlines\n      query = query.trim();\n\n      return query;\n    },\n    getQueryLang() {\n      return $.trim(settings.code[\"overpass\"]).match(/^</)\n        ? \"xml\"\n        : \"OverpassQL\";\n    },\n    async update_map() {\n      $(\"#data_stats\").remove();\n      if (typeof overpass.osmLayer != \"undefined\")\n        ide.map.removeLayer(overpass.osmLayer);\n      const query = await ide.getQuery();\n      const query_lang = ide.getQueryLang();\n      overpass.run_query(\n        query,\n        query_lang,\n        cache,\n        false,\n        undefined,\n        undefined,\n        ide.mapcss\n      );\n      $(\"#map_blank\").remove();\n    }\n  };\n  overpass.init();\n  // (very raw) compatibility check\n  if ($.support.cors != true || false) {\n    // the currently used browser is not capable of running the IDE. :(\n    $(\n      '<div title=\"Your browser is not supported :(\">' +\n        '<p>The browser you are currently using, is not capable of running this Application. <small>It has to support <a href=\"http://en.wikipedia.org/wiki/Cross-origin_resource_sharing\">cross origin resource sharing (CORS)</a>.</small></p>' +\n        '<p>Please update to a more up-to-date version of your browser or switch to a more capable browser! Recent versions of <a href=\"http://www.opera.com\">Opera</a>, <a href=\"http://www.google.com/intl/de/chrome/browser/\">Chrome</a> and <a href=\"http://www.mozilla.org/de/firefox/\">Firefox</a> have been tested to work.</p>' +\n        \"</div>\"\n    ).dialog({modal: true});\n  }\n  // check for any get-parameters\n  const params = parseUrlParameters();\n  // uncompressed query set in url\n  settings.code[\"overpass\"] = params.get(\"Q\");\n  // don't alert on overpass errors, but send messages to parent window\n  settings.silent = params.has(\"silent\");\n  // init leaflet\n  ide.map = new L.Map(\"map\");\n  const tilesUrl = settings.tileServer;\n  const tilesAttrib = configs.tileServerAttribution;\n  const tiles = new L.TileLayer(tilesUrl, {attribution: tilesAttrib});\n  ide.map.setView([0, 0], 1).addLayer(tiles);\n  const scaleControl = new L.Control.Scale({metric: true, imperial: false});\n  scaleControl.addTo(ide.map);\n  // wait spinner\n  $(document).on({\n    ajaxStart() {\n      $(\"#loading-dialog\").addClass(\"is-active\");\n    },\n    ajaxStop() {\n      $(\"#loading-dialog\").removeClass(\"is-active\");\n    }\n  });\n  ide.map.on(\"layeradd\", (e) => {\n    if (!(e.layer instanceof L.GeoJSON)) return;\n    ide.map.setView([0, 0], 18, true);\n    try {\n      ide.map.fitBounds(e.layer.getBounds());\n    } catch (err) {}\n  });\n  // overpass functionality\n  overpass.handlers[\"onEmptyMap\"] = (empty_msg) => {\n    $(\n      `<div id=\"map_blank\" style=\"z-index:700; display:block; position:absolute; top:50px; width:100%; text-align:center; background-color:#eee; opacity: 0.8;\">This map intentionally left blank. <small>(${empty_msg})</small></div>`\n    ).appendTo(\"#map\");\n  };\n  if (settings.silent) {\n    overpass.handlers[\"onAjaxError\"] = (errmsg) => {\n      parent.postMessage(\n        JSON.stringify({handler: \"onAjaxError\", msg: errmsg}),\n        \"*\"\n      );\n    };\n    overpass.handlers[\"onQueryError\"] = (errmsg) => {\n      parent.postMessage(\n        JSON.stringify({handler: \"onQueryError\", msg: errmsg}),\n        \"*\"\n      );\n    };\n  } else {\n    overpass.handlers[\"onAjaxError\"] = (errmsg) => {\n      alert(\n        `An error occured during the execution of the overpass query!\\n${errmsg}`\n      );\n    };\n    overpass.handlers[\"onQueryError\"] = (errmsg) => {\n      alert(\n        `An error occured during the execution of the overpass query!\\nThis is what overpass API returned:\\n${errmsg}`\n      );\n    };\n  }\n  overpass.handlers[\"onGeoJsonReady\"] = () => {\n    ide.map.addLayer(overpass.osmLayer);\n  };\n  overpass.handlers[\"onPopupReady\"] = (p) => {\n    p.openOn(ide.map);\n  };\n  overpass.handlers[\"onDataReceived\"] = (\n    amount,\n    txt,\n    elements,\n    abortCB,\n    continueCB\n  ) => {\n    continueCB();\n  };\n  overpass.handlers[\"onRawDataPresent\"] = () => {\n    parent.postMessage(\n      JSON.stringify({\n        query: settings.code[\"overpass\"],\n        resultType: overpass.resultType,\n        resultText: overpass.resultText\n      }),\n      \"*\"\n    );\n  };\n  // load the data\n  ide.update_map();\n});\n"],"mappings":"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"}